<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html">
<h:head>
    <meta charset="UTF-8"/>
    <title>APT - Appointments</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" integrity="sha512-8bHTC73gkZ7rZ7vpqUQThUDhqcNFyYi2xgDgPDHc+GXVGHXq+xPjynxIopALmOPqzo9JZj0k6OqqewdGO3EsrQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js" integrity="sha512-dqw6X88iGgZlTsONxZK9ePmJEFrmHwpuMrsUChjAw1mRUhUITE5QU9pkcSox+ynfLhL15Sv2al5A0LVyDCmtUw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</h:head>
<h:body>
    <div class="ui inverted huge top fixed menu">
        <div class="ui container">
            <a href="/" class="header item">
                APT
            </a>
            <a href="/appointments" class="item">Appointments</a>
            <div class="right menu">
                <a href="/account" class="item">
                    <i class="user icon"></i>
                </a>
            </div>
        </div>
    </div>
    <br/>
    <br/>
    <br/>
    <div class="ui container">
        <br/>
        <h1 class="ui header">
            Appointments
            <div class="sub header">Manage your appointments</div>
        </h1>
        <a href="/">Home > </a>
        <br/>
        <br/>
        <b>Not Confirmed = Lecturer needs to confirm the appointment</b>
        <br/>
        <b>Confirmed = Lecturer confirmed the appointment</b>
        <br/>
        <b>Cancelled = Student or lecturer cancelled the appointment</b> <br/>
        <br/>
        <a href="/create-appointment" class="ui green button" style="display: none" id="createNewButton"> <i class="plus icon"></i> Create New</a>
        <table class="ui celled table">
            <thead>
            <tr>
                <th>With who?</th>
                <th>Day</th>
                <th>Starts At</th>
                <th>Ends At</th>
                <th>Status</th>
                <th></th>
            </tr></thead>
            <tbody id="appointmentTable">

            </tbody>
        </table>
    </div>

    <script>
        let appointments;
        let currentUser;

        window.onload = async () => {
            currentUser = await getCurrentUser();
            appointments = await fetchAppointments();
            console.log(appointments);
            if(currentUser.role === "STUDENT") {
                renderStudentTable(appointments);
                document.getElementById("createNewButton").style.display = "";
            }
            if(currentUser.role === "LECTURER") {
                renderLecturerTable(appointments);
            }
        }

        const getCurrentUser = async () => {
            const res = await fetch("/current-user");
            if(res.ok) {
                return await res.json();
            }
        }

        const fetchAppointments = async () => {
            let res;
            if(currentUser.role === "STUDENT") {
                res = await fetch("/api/appointments/student/" + currentUser.email);
            } else {
                res = await fetch("/api/appointments/lecturer/" + currentUser.email);
            }
            return await res.json();
        }

        const confirm = async appointmentID => {
            const res = await fetch("/api/appointments/confirm/" + appointmentID, {
                method: "PATCH"
            });
            if(res.ok) {
                document.location.reload();
            }
        }

        const renderStudentTable = (appointments) => {
            appointments.forEach((a) => {
                document.getElementById("appointmentTable").innerHTML += `&lt;tr>
            &lt;td data-label="">` + a.lecturer  + `&lt;/td>
            &lt;td data-label="startsAt">` + new Date(a.startsAt).toLocaleDateString("de-DE") + `&lt;/td>
            &lt;td data-label="startsAt">` + new Date(a.startsAt).toLocaleTimeString() + `&lt;/td>
            &lt;td data-label="endsAt">` + new Date(a.endsAt).toLocaleTimeString() + `&lt;/td>
            &lt;td data-label="Status">` + (a.confirmed ? "Confirmed" : "Not Confirmed") + `&lt;/td>
            &lt;td data-label="Delete">
                &lt;button class="ui secondary button" onclick="del(` + a.id + `)">
                    &lt;i class="eye icon">&lt;/i> Read More
                &lt;/button>
            &lt;/td>
        &lt;/tr>`
            })

        }

        const renderLecturerTable = (appointments) => {
            appointments.forEach((a) => {
                document.getElementById("appointmentTable").innerHTML += `&lt;tr>
            &lt;td data-label="">` + a.student  + `&lt;/td>
            &lt;td data-label="startsAt">` + new Date(a.startsAt).toLocaleDateString("de-DE") + `&lt;/td>
            &lt;td data-label="startsAt">` + new Date(a.startsAt).toLocaleTimeString() + `&lt;/td>
            &lt;td data-label="endsAt">` + new Date(a.endsAt).toLocaleTimeString() + `&lt;/td>
            &lt;td data-label="Status">` + renderStatus(a) + `&lt;/td>
            &lt;td data-label="Delete">
                &lt;button class="ui secondary button" onclick="del(` + a.id + `)">
                    &lt;i class="eye icon">&lt;/i> Read More
                &lt;/button>
            &lt;/td>
        &lt;/tr>`
            })

        }

        const renderStatus = appointment => {
            if(appointment.cancelled === true) {
                return "Cancelled";
            }
            if(appointment.confirmed === true) {
                return "Confirmed";
            }
            if(appointment.confirmed === false) {
                return `&lt;button class="ui blue button" onclick="confirm(` + appointment.id + `)">
                   Confirm
                &lt;/button>`
            }
        }
    </script>
</h:body>
</html>