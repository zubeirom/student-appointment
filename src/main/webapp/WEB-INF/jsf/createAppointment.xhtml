<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html">
<h:head>
    <meta charset="UTF-8"/>
    <title>Create Appoinment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css"
          integrity="sha512-8bHTC73gkZ7rZ7vpqUQThUDhqcNFyYi2xgDgPDHc+GXVGHXq+xPjynxIopALmOPqzo9JZj0k6OqqewdGO3EsrQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
            integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"
            integrity="sha512-dqw6X88iGgZlTsONxZK9ePmJEFrmHwpuMrsUChjAw1mRUhUITE5QU9pkcSox+ynfLhL15Sv2al5A0LVyDCmtUw=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</h:head>
<h:body>
    <div class="ui inverted huge top fixed menu">
        <div class="ui container">
            <a href="/" class="header item">
                APT
            </a>
            <a href="/appointments" class="item">Appointments</a>
            <div class="right menu">
                <a href="/account" class="item">
                    <i class="user icon"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="ui container">
        <br/>
        <br/>
        <br/>
        <h1>Create A New Appointment</h1>
        <a href="/">Home > </a>
        <h4 class="ui dividing header">Lecturers</h4>
        <form class="ui form">
            <div class="grouped fields" id="radioField">
            </div>
        </form>

        <h4 class="ui dividing header">Select date and time</h4>
        <div class="ui grid">
            <div class="ui eight wide column">
                <input type="text" id="datepicker" placeholder="Select Date..." />
            </div>
            <div class="ui eight wide column">
                <div class="grouped fields" id="timesRadio"></div>
            </div>
        </div>

        <h4 class="ui dividing header">Select participants</h4>
        <select class="ui fluid search dropdown" multiple="">
            <option value="">State</option>
            <option value="AL">Alabama</option>
            <option value="AK">Alaska</option>
            <option value="AZ">Arizona</option>
            <option value="AR">Arkansas</option>
            <option value="CA">California</option>
            <option value="CO">Colorado</option>
            <option value="CT">Connecticut</option>
            <option value="DE">Delaware</option>
            <option value="DC">District Of Columbia</option>
            <option value="FL">Florida</option>
            <option value="GA">Georgia</option>
            <option value="HI">Hawaii</option>
            <option value="ID">Idaho</option>
            <option value="IL">Illinois</option>
            <option value="IN">Indiana</option>
            <option value="IA">Iowa</option>
            <option value="KS">Kansas</option>
            <option value="KY">Kentucky</option>
            <option value="LA">Louisiana</option>
            <option value="ME">Maine</option>
            <option value="MD">Maryland</option>
            <option value="MA">Massachusetts</option>
            <option value="MI">Michigan</option>
            <option value="MN">Minnesota</option>
            <option value="MS">Mississippi</option>
            <option value="MO">Missouri</option>
            <option value="MT">Montana</option>
            <option value="NE">Nebraska</option>
            <option value="NV">Nevada</option>
            <option value="NH">New Hampshire</option>
            <option value="NJ">New Jersey</option>
            <option value="NM">New Mexico</option>
            <option value="NY">New York</option>
            <option value="NC">North Carolina</option>
            <option value="ND">North Dakota</option>
            <option value="OH">Ohio</option>
            <option value="OK">Oklahoma</option>
            <option value="OR">Oregon</option>
            <option value="PA">Pennsylvania</option>
            <option value="RI">Rhode Island</option>
            <option value="SC">South Carolina</option>
            <option value="SD">South Dakota</option>
            <option value="TN">Tennessee</option>
            <option value="TX">Texas</option>
            <option value="UT">Utah</option>
            <option value="VT">Vermont</option>
            <option value="VA">Virginia</option>
            <option value="WA">Washington</option>
            <option value="WV">West Virginia</option>
            <option value="WI">Wisconsin</option>
            <option value="WY">Wyoming</option>
        </select>

        <h4 class="ui dividing header">Description</h4>
        <textarea rows="5" class="ui fluid input" placeholder="Write your description" />

    </div>
    <script>
        let lecturers;
        let avails;
        // Weekdays in number [0,1,2]
        let weekdays;
        let availsForLecturer;
        let selectedLecturer;

        window.onload = async function () {
            lecturers = await fetchLecturer();
            avails = await fetchAvailability();
            mapLecturerToRadio(lecturers);
            availsForLecturer = avails.filter(a => a.lecturer === "mary@jane.com");
            weekdays = avails.map(a => {
                if(a.lecturer === "mary@jane.com") {
                    return getIndexOfWeekday(a.weekday);
                }
            });
            $( "#datepicker" ).datepicker({
                beforeShowDay: isAvailable,
                onSelect: dateSelected
            });
            $('.ui.dropdown').dropdown();
        }

        const indexToDay = (weekday) => {
            switch(weekday) {
                case 0:
                    return "SUNDAY";
                case 1:
                    return "MONDAY";
                case 2:
                    return "TUESDAY";
                case 3:
                    return "WEDNESDAY";
                case 4:
                    return "THURSDAY";
                case 5:
                    return "FRIDAY";
                case 6:
                    return "SATURDAY";
            }
        }

        const dateSelected = d => {
            const i = $( "#datepicker" ).datepicker( "getDate" ).getDay();

            console.log(i);

            const day = indexToDay(i);

            console.log(availsForLecturer);

            const byDate = availsForLecturer.filter(a => a.weekday === day);
            mapTimesToRadio(byDate);
        }

        const isAvailable = (d) => {
            if(weekdays.includes(d.getDay())) {
                return [true, "av", "Available"];
            }
            return [false, "notav", 'Not Available'];
        }

        const fetchLecturer = async () => {
            const res = await fetch("/lecturers");
            return await res.json();
        }

        const fetchAvailability = async () => {
            const res = await fetch("/availabilities");
            return await res.json();
        }

        const filterByLecturer = (lecturer) => {
            return avails.filter(a => a.lecturer === lecturer);
        }

        const getIndexOfWeekday = wd => {
            switch(wd) {
                case "SUNDAY":
                    return 0;
                case "MONDAY":
                    return 1;
                case "TUESDAY":
                    return 2;
                case "WEDNESDAY":
                    return 3;
                case "THURSDAY":
                    return 4;
                case "FRIDAY":
                    return 5;
                case "SATURDAY":
                    return 6;
            }
        }

        const mapLecturerToRadio = (lecturers) => {
            lecturers.forEach((l) => {
                document.getElementById("radioField").innerHTML += `&lt;div class="field">
      &lt;div class="ui radio checkbox">
        &lt;input type="radio" name="example2">
        &lt;label>` + l.firstName + " " + l.lastName + `&lt;/label>
      &lt;/div>
    &lt;/div>`
            });
        }

        const mapTimesToRadio = (avails) => {
            document.getElementById("timesRadio").innerHTML  = "";
            avails.forEach((a) => {
                document.getElementById("timesRadio").innerHTML += `&lt;div class="field">
      &lt;div class="ui radio checkbox">
        &lt;input type="radio" name="timesRadio" value="`+ a.id +`">
        &lt;label>` + a.startsAt + " - " + a.endsAt + `&lt;/label>
      &lt;/div>
    &lt;/div>`
            });
        }
    </script>
</h:body>
</html>